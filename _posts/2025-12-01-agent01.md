---
title: Learning Agent - 01 
categories: [AI, agent]
tags: [AI, agent, learn]
---

å‚è€ƒæ•™ç¨‹ï¼š
> https://www.datacamp.com/tutorial/langgraph-tutorial

### 0x01 ç”¨LangGraphæ„å»ºå•èŠ‚ç‚¹ChatBot

```python
import os
from dotenv import load_dotenv
from pydantic import SecretStr
from IPython.display import Image, display

from typing import Annotated
from typing_extensions import TypedDict
from langgraph.graph import StateGraph
from langgraph.graph.message import add_messages
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser


load_dotenv('../../.llm_env')
API_KEY : str= os.getenv("MY_OPENAI_API_KEY") or ""
BASE_URL = os.getenv("MY_OPENAI_API_BASE")

llm = ChatOpenAI(api_key=SecretStr(API_KEY),  base_url=BASE_URL,  model="gpt-4.1",temperature=0)

class State(TypedDict):
    # messages have the type "list".
    # The add_messages function appends messages to the list, rather than overwriting them
    messages: Annotated[list, add_messages]
graph_builder = StateGraph(State)

# Set entry and finish points
graph_builder.set_entry_point("chatbot")
graph_builder.set_finish_point("chatbot")

# node
def chatbot(state: State):
    print(state)
    return {"messages": [llm.invoke(state["messages"])]}
# The first argument is the unique node name
# The second argument is the function or object that will be called whenever the node is used.â€™â€™â€™
graph_builder.add_node("chatbot", chatbot)

graph = graph_builder.compile()
try:
    with open("struct.png", "wb") as f:
        f.write(graph.get_graph().draw_mermaid_png())
except Exception:
    print('error')

# Run the chatbot
while True:
    user_input = input("User: ")
    if user_input.lower() in ["quit", "exit", "q"]:
        print("Goodbye!")
        break
    for event in graph.stream({"messages": [("user", user_input)]}):
        for value in event.values():
            print("Assistant:", value["messages"][-1].content)
```

å…³é”®æ­¥éª¤ï¼š
- åˆ›å»ºllmå®ä¾‹
- è®¾ç½®`State`, å®šä¹‰èŠ‚ç‚¹
```python
class State(TypedDict):
    # messages have the type "list".
    # The add_messages function appends messages to the list, rather than overwriting them
    messages: Annotated[list, add_messages]
graph_builder = StateGraph(State)
```
å¯ä»¥æŠŠ`State`ç†è§£ä¸ºåœ¨ä¸åŒçš„èŠ‚ç‚¹ç›´æ¥ä¼ é€’çš„â€œä¸Šä¸‹æ–‡çŠ¶æ€â€ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æ¥å—ä¸€ä¸ªState,æ–½åŠ è‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘ï¼š
```python
def chatbot(state: State):
    print(state)
    return {"messages": [llm.invoke(state["messages"])]}
...
graph_builder.add_node("chatbot", chatbot)  # ä½¿ç”¨chatbotå‡½æ•°å¤„ç†"chatbot"èŠ‚ç‚¹æ¥å—åˆ°çš„State
```
ç„¶åäº§ç”Ÿä¸€ä¸ªæ–°çš„State,å¹¶ç»§ç»­å‘åä¼ é€’.

> - TypeDictç±»å‹ä¼šå»ºç«‹ä¸€ä¸ªåˆ—è¡¨ï¼Œå®šä¹‰æ—¶çš„æˆå‘˜åä¼šæˆä¸ºæœ€åçš„`key`ï¼Œè€Œå¯¹åº”çš„`value`ç±»å‹ä¹Ÿåœ¨`:`åè¢«åˆ¶å®š
- Annotatedæ¥å—ä¸€ä¸ªç±»å‹å’Œé™„åŠ ä¿¡æ¯ï¼Œæ¯”å¦‚`Annotated[str, "info"]`ï¼Œè¿™é‡Œæˆ‘ä»¬çš„Annotatedç±»å‹æ˜¯`list`ï¼Œé™„åŠ ä¿¡æ¯ç”¨æ¥æé†’ï¼šåœ¨ä¸åŒNodeé—´ä¼ é€’çš„æ—¶å€™ï¼Œåœ¨åˆ—è¡¨åå¢åŠ ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç›´æ¥æ›¿æ¢ä¿¡æ¯.
{: .prompt-info}

- ç¼–è¯‘graphå¹¶å¼€å§‹è¿è½¬
```python
while True:
    user_input = input("User: ")
    if user_input.lower() in ["quit", "exit", "q"]:
        print("Goodbye!")
        break
    for event in graph.stream({"messages": [("user", user_input)]}):
        for value in event.values():
            print("Assistant:", value["messages"][-1].content)
```
å½“è°ƒç”¨streamçš„æ—¶å€™ï¼Œä¼šæŠŠä¿¡æ¯`{"messages": [("user", user_input)]}` ä½œä¸ºåˆå§‹çš„Stateä¼ é€’åˆ°`_start`å¤„ï¼Œå½“æ•°æ®åˆ°è¾¾`_end`åï¼Œè¯»å–`event`ä¸­çš„æ•°å€¼ã€‚

> æ³¨æ„å’Œä¸Šé¢Stateä¸­çš„add_messageåŒºåˆ†ï¼šè¿™é‡Œæ¯æ¬¡ç”¨æˆ·è¾“å…¥éƒ½ä¼šæŠŠå½“å‰çš„æç¤ºè¯ä½œä¸ºåˆå§‹Stateï¼Œå› æ­¤ä¸¤æ¬¡è¾“å…¥ä¹‹é—´æ²¡æœ‰ä»»ä½•æç¤ºè¯å…³è”; å‰é¢æ‰€è°“çš„"add_messageè€Œéæ¸…ç©º"æŒ‡çš„æ˜¯åœ¨åŒä¸€æ¬¡è¾“å…¥ä¸­ï¼Œä¸åŒNodeä¹‹é—´è½¬ç§»çš„è¿‡ç¨‹ä¸­å¯¹Stateå¢åŠ ä¿¡æ¯ã€‚
æµ‹è¯•ï¼š
```
User: hello, your name is anla
{'messages': [HumanMessage(content='hello, your name is anla', additional_kwargs={}, response_metadata={}, id='500b6144-f418-4dc3-818a-339ff01ad07d')]}
Assistant: Hello! Nice to meet you. Yes, you can call me Anla. How can I help you today? ğŸ˜Š
User: what's your name
{'messages': [HumanMessage(content="what's your name", additional_kwargs={}, response_metadata={}, id='fea56bf2-3dca-4dd7-aaaa-bf48320170e9')]}
Assistant: I'm ChatGPT, your AI assistant! How can I help you today?
```
{: .prompt-info}


### 0x02 



### 0x03 å¤šèŠ‚ç‚¹
